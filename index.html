<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Our Dates ‚ù§Ô∏è</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #ffeef8 0%, #ffe0f0 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
            overflow-x: hidden;
        }
        .container { max-width: 500px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 2em; color: #8B0000; margin-top: 10px; user-select: none; }
        .emoji {
            font-size: 3em;
            cursor: pointer;
            user-select: none;
            transition: transform 0.3s ease;
        }
        .emoji:active { transform: scale(0.9); }
        .emoji.locked { filter: grayscale(100%) brightness(1.2); opacity: 0.7; }
        .emoji.unlocking { animation: heartUnlock 0.8s ease-out forwards; }
        @keyframes heartUnlock {
            0% { filter: grayscale(100%) brightness(1.2); opacity: 0.7; transform: scale(1); }
            30% { transform: scale(1.3); }
            50% { filter: grayscale(50%) brightness(1.1); opacity: 0.85; }
            70% { transform: scale(0.9); }
            100% { filter: grayscale(0%) brightness(1); opacity: 1; transform: scale(1); }
        }
        .screen { display: none; }
        .screen.active { display: block; }
        .category-title { text-align: center; font-size: 1.5em; margin-bottom: 20px; color: #333; }
        .category-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .category-btn {
            padding: 30px 20px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s, opacity 0.3s;
            font-family: 'Georgia', serif;
            user-select: none; /* FIX #3 - prevent text selection */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .category-btn:active { transform: scale(0.95); }
        .category-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(50%);
        }
        .category-btn.holding {
            box-shadow: 0 0 20px rgba(255,255,255,0.6);
            animation: pulseGlow 0.5s ease-in-out infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255,255,255,0.6); }
            50% { box-shadow: 0 0 30px rgba(255,255,255,0.9); }
        }
        .category-btn.dnevni { background-color: #E63946; }
        .category-btn.vikend { background-color: #FF69B4; }
        .category-btn.mjesecni { background-color: #C77DFF; }
        .category-btn.godisnji { background-color: #8B0000; }
        .flip-container { perspective: 1000px; margin: 40px auto; }
        .flip-card {
            width: 100%;
            min-height: 300px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        .flip-card.flipped { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            min-height: 300px;
            backface-visibility: hidden;
            border-radius: 20px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .flip-card-front { background: white; }
        .flip-card-back { background: #fff9f9; transform: rotateY(180deg); }
        .date-title { font-size: 2em; font-weight: bold; margin-bottom: 10px; }
        .date-description { font-size: 1.2em; line-height: 1.6; color: #333; }
        .action-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            font-family: 'Georgia', serif;
            user-select: none;
        }
        .btn:active { transform: scale(0.95); }
        .btn-accept { background-color: #28a745; color: white; }
        .btn-replace { background-color: #6c757d; color: white; }
        .btn-back { background-color: #dc3545; color: white; width: 100%; margin-top: 20px; }
        .upload-container { text-align: center; padding: 40px 20px; }
        .upload-title { font-size: 1.5em; margin-bottom: 30px; color: #333; }
        .upload-options { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .upload-btn {
            padding: 20px;
            background: #E63946;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            font-family: 'Georgia', serif;
            user-select: none;
        }
        .upload-btn.secondary { background: #FF69B4; }
        .file-input { display: none; }
        .preview-container { margin: 20px 0; }
        .preview-image { max-width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .date-selector { margin: 20px 0; padding: 20px; background: #fff9f9; border-radius: 15px; }
        .date-selector-label {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }
        .date-selector-dropdown {
            width: 100%;
            padding: 15px;
            font-size: 1em;
            border: 2px solid #E63946;
            border-radius: 10px;
            font-family: 'Georgia', serif;
            background: white;
            cursor: pointer;
        }
        .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .gallery-item {
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 10px;
            cursor: pointer;
            position: relative;
        }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-item-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            font-size: 0.7em;
        }
        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            padding: 20px;
        }
        .fullscreen-overlay.active { display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .fullscreen-image { max-width: 100%; max-height: 80vh; border-radius: 10px; }
        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            cursor: pointer;
        }
        .stats-container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        .stat-item:last-child { border-bottom: none; }
        .stat-label { font-weight: bold; }
        .stat-value { font-size: 1.2em; color: #E63946; }
        .export-buttons { margin-top: 30px; display: flex; flex-direction: column; gap: 15px; }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .nav-btn {
            background: none;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-size: 0.9em;
            color: #666;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: box-shadow 0.3s;
            user-select: none;
        }
        .nav-btn.active { color: #E63946; }
        .nav-btn.holding { animation: pulseGlow 0.5s ease-in-out infinite; }
        .nav-icon { font-size: 1.5em; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state-icon { font-size: 4em; margin-bottom: 20px; }
        .love-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: none;
            overflow: hidden;
        }
        .love-overlay.active { display: block; }
        .love-message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 10001;
            text-align: center;
            min-width: 300px;
            animation: popIn 0.5s ease-out;
        }
        .love-message-title { font-size: 1.2em; color: #666; margin-bottom: 15px; }
        .love-message-text { font-size: 2em; color: #E63946; font-weight: bold; margin-bottom: 25px; }
        .love-close-btn {
            background: #E63946;
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Georgia', serif;
        }
        .floating-heart {
            position: fixed;
            font-size: 2.5em;
            pointer-events: none;
            z-index: 10000;
            animation: floatBalloon 8s ease-in-out infinite;
        }
        @keyframes popIn {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        @keyframes floatBalloon {
            0% { opacity: 0; transform: translateY(0) translateX(0) rotate(0deg) scale(1); }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-100vh) translateX(var(--random-x)) rotate(var(--random-rotate)) scale(0.5); }
        }
        .easter-modal, .tracker-modal, .warning-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .easter-modal.active, .tracker-modal.active, .warning-modal.active { display: flex; }
        .easter-content, .tracker-content, .warning-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            animation: popIn 0.5s ease-out;
        }
        .easter-icon, .tracker-icon, .warning-icon { font-size: 4em; margin-bottom: 20px; }
        .easter-title, .tracker-title, .warning-text {
            font-size: 1.5em;
            color: #E63946;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .easter-text, .tracker-progress, .warning-subtext {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        .tracker-progress { font-size: 2.5em; color: #E63946; font-weight: bold; margin-bottom: 30px; }
        .tracker-hint-section { background: #fff9f9; padding: 20px; border-radius: 15px; margin-bottom: 25px; }
        .tracker-hint-title { font-size: 1em; color: #E63946; font-weight: bold; margin-bottom: 10px; }
        .tracker-hint-text { font-size: 1.1em; color: #666; font-style: italic; line-height: 1.4; }
        .easter-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 20px;
            font-family: 'Georgia', serif;
            text-align: center;
        }
        .easter-button, .tracker-button, .warning-button {
            background: #E63946;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Georgia', serif;
            margin: 5px;
            user-select: none;
        }
        .easter-button.secondary { background: #6c757d; }
    </style>
</head>
<body>
        <div class="container">
        <div class="header">
            <div class="emoji locked" id="logoEmoji">‚ù§Ô∏è</div>
            <h1 id="appTitle">Our Dates</h1>
        </div>

        <!-- HOME SCREEN -->
        <div id="homeScreen" class="screen active">
            <div class="category-title">Odaberi kategoriju</div>
            <div class="category-grid">
                <button class="category-btn dnevni" id="dnevniBtn">Dnevni</button>
                <button class="category-btn vikend" id="vikendBtn">Vikend</button>
                <button class="category-btn mjesecni" id="mjesecniBtn">Mjeseƒçni</button>
                <button class="category-btn godisnji" id="godisnjiBtn">Godi≈°nji</button>
            </div>
        </div>

        <!-- DATE SCREEN -->
        <div id="dateScreen" class="screen">
            <div class="flip-container">
                <div class="flip-card" id="flipCard" onclick="toggleFlip()">
                    <div class="flip-card-front">
                        <div class="date-title" id="dateTitle"></div>
                        <p style="color: #999; margin-top: 20px;">üëÜ Klikni za opis</p>
                    </div>
                    <div class="flip-card-back">
                        <div class="date-description" id="dateDescription"></div>
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-accept" onclick="acceptDate()">Prihvati</button>
                <button class="btn btn-replace" onclick="replaceDate()">Zamijeni</button>
            </div>
            <button class="btn btn-back" onclick="goBackFromDate()">Natrag</button>
        </div>

        <!-- UPLOAD SCREEN -->
        <div id="uploadScreen" class="screen">
            <div class="upload-container">
                <div class="upload-title">Dodaj sliku</div>
                
                <div class="date-selector" id="dateSelector" style="display: none;">
                    <label class="date-selector-label">Za koji dejt je ova slika?</label>
                    <select class="date-selector-dropdown" id="dateSelectorDropdown"></select>
                </div>
                
                <div class="upload-options">
                    <button class="upload-btn" onclick="openCamera()">üì∑ Kamera</button>
                    <button class="upload-btn secondary" onclick="openGallery()">üñºÔ∏è Galerija</button>
                </div>
                <input type="file" id="cameraInput" class="file-input" accept="image/*" capture="environment" onchange="handleImageUpload(event)">
                <input type="file" id="galleryInput" class="file-input" accept="image/*" onchange="handleImageUpload(event)">
                <div class="preview-container" id="previewContainer"></div>
                
                <button class="btn btn-back" id="cancelUploadBtn" onclick="cancelUpload()" style="display: none;">Odustani</button>
            </div>
        </div>

        <!-- GALLERY SCREEN -->
        <div id="galleryScreen" class="screen">
            <div class="category-title">Galerija</div>
            <div class="gallery-grid" id="galleryGrid"></div>
            <div class="empty-state" id="emptyGallery" style="display: none;">
                <div class="empty-state-icon">üì∑</div>
                <p>Jo≈° nema slika.<br>Poƒçnite dodavati dejtove!</p>
            </div>
        </div>

        <!-- STATS SCREEN -->
        <div id="statsScreen" class="screen">
            <div class="category-title">Godi≈°nja Statistika</div>
            <div class="stats-container">
                <div class="stat-item">
                    <span class="stat-label">Ukupno odraƒëeno:</span>
                    <span class="stat-value" id="totalCompleted">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Dnevni:</span>
                    <span class="stat-value" id="dnevniCompleted">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Vikend:</span>
                    <span class="stat-value" id="vikendCompleted">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Mjeseƒçni:</span>
                    <span class="stat-value" id="mjesecniCompleted">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Godi≈°nji:</span>
                    <span class="stat-value" id="godisnjiCompleted">0</span>
                </div>
            </div>
            <div class="export-buttons">
                <button class="btn btn-accept" onclick="exportJSON()">üíæ Preuzmi Backup (JSON)</button>
                <button class="btn btn-replace" onclick="exportZIP()">üì¶ Preuzmi Sve Slike (ZIP)</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <button class="fullscreen-close" onclick="closeFullscreen()">‚úï</button>
        <img class="fullscreen-image" id="fullscreenImage" src="">
    </div>

    <div class="love-overlay" id="loveOverlay">
        <div class="love-message-box">
            <div class="love-message-title">Tajna poruka:</div>
            <div class="love-message-text">Toliko te volim ‚ù§Ô∏è</div>
            <button class="love-close-btn" onclick="closeLoveAnimation()">Zatvori</button>
        </div>
    </div>

    <div class="warning-modal" id="warningModal">
        <div class="warning-content">
            <div class="warning-icon">üíî</div>
            <div class="warning-text">Love energy depleting!</div>
            <div class="warning-subtext">Pro≈°lo je 7+ dana bez dejta.<br>Vrijeme je za novu avanturu!</div>
            <button class="warning-button" onclick="closeWarning()">Idemo! üíï</button>
        </div>
    </div>

    <div class="tracker-modal" id="trackerModal">
        <div class="tracker-content">
            <div class="tracker-icon">üéÅ</div>
            <div class="tracker-title">Ova aplikacija sadr≈æi<br>tajne poruke/dejtove</div>
            <div class="tracker-progress" id="trackerProgress">0/4</div>
            <div class="tracker-hint-section" id="trackerHintSection">
                <div class="tracker-hint-title" id="trackerHintTitle">üîç Tajni Dejt #1</div>
                <div class="tracker-hint-text" id="trackerHintText">Uƒçitavam...</div>
            </div>
            <button class="tracker-button" onclick="closeTracker()">U redu! üíï</button>
        </div>
    </div>

    <div class="easter-modal" id="easterModal1">
        <div class="easter-content">
            <div class="easter-icon">üíÜ‚Äç‚ôÄÔ∏è</div>
            <div class="easter-title">üéâ TAJNI DEJT OTKRIVEN! üéâ</div>
            <div class="easter-text">
                Josip mora bez pogovora<br>
                izmasirati jedan dio tijela<br>
                po tvom izboru!<br><br>
                <strong>Trajanje: minimum 15 min</strong>
            </div>
            <button class="easter-button" onclick="completeEasterEgg(1)">Odliƒçno! üíï</button>
        </div>
    </div>

    <div class="easter-modal" id="easterModal2">
        <div class="easter-content">
            <div class="easter-icon">ü•ê</div>
            <div class="easter-title">üíù SECRET UNLOCKED! üíù</div>
            <div class="easter-text">
                Josip mora:<br>
                - Napraviti ti doruƒçak u krevet<br>
                - Uz to ljubavnu poruku
            </div>
            <button class="easter-button" onclick="completeEasterEgg(2)">Yay! ‚ù§Ô∏è</button>
        </div>
    </div>

    <div class="easter-modal" id="easterModal3">
        <div class="easter-content">
            <div class="easter-icon">üîê</div>
            <div class="easter-title">UPI≈†I TAJNU ≈†IFRU</div>
            <div class="easter-text">Poƒçetak moje i tvoje (na≈°e) priƒçe</div>
            <input type="text" class="easter-input" id="secretCodeInput" placeholder="****" maxlength="4">
            <button class="easter-button" onclick="checkSecretCode()">Potvrdi</button>
            <button class="easter-button secondary" onclick="closeEasterModal('easterModal3')">Odustani</button>
        </div>
    </div>

    <div class="easter-modal" id="easterModal3Success">
        <div class="easter-content">
            <div class="easter-icon">‚ù§Ô∏è</div>
            <div class="easter-title">MASTER SECRET ‚ù§Ô∏è</div>
            <div class="easter-text">
                Josip mora ispuniti<br>
                jednu tvoju ≈æelju<br>
                bez ikakvih pitanja!<br><br>
                <small>(Razumna ≈æelja, naravno üòâ)</small>
            </div>
            <button class="easter-button" onclick="completeEasterEgg(3)">Perfect! üíñ</button>
        </div>
    </div>

    <div class="easter-modal" id="easterModal4">
        <div class="easter-content">
            <div class="easter-icon">üßÆ</div>
            <div class="easter-title">MATEMATIƒåKA ZAGONETKA</div>
            <div class="easter-text">
                Rije≈°i sustav jednad≈æbi:<br><br>
                <strong>2x + y = 10</strong><br>
                <strong>x - y = 2</strong><br><br>
                Koliko je <strong>x</strong>?
            </div>
            <input type="number" class="easter-input" id="mathAnswerInput" placeholder="?">
            <button class="easter-button" onclick="checkMathAnswer()">Potvrdi</button>
            <button class="easter-button secondary" onclick="closeEasterModal('easterModal4')">Odustani</button>
        </div>
    </div>

    <div class="easter-modal" id="easterModal4Success">
        <div class="easter-content">
            <div class="easter-icon">üåπ</div>
            <div class="easter-title">ROMANTIC BONUS üåπ</div>
            <div class="easter-text">
                Josip mora:<br>
                - Isplanirati iznenaƒëenje dejt<br>
                - U sljedeƒáih 7 dana<br><br>
                Sretno! üíï
            </div>
            <button class="easter-button" onclick="completeEasterEgg(4)">Jedva ƒçekam! üòç</button>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <button class="nav-btn active" id="homeNavBtn" onclick="navClick('home')">
            <span class="nav-icon">üè†</span>
            <span>Home</span>
        </button>
        <button class="nav-btn" id="galleryNavBtn" onclick="navClick('gallery')">
            <span class="nav-icon">üì∑</span>
            <span>Galerija</span>
        </button>
        <button class="nav-btn" id="statsNavBtn" onclick="navClick('stats')">
            <span class="nav-icon">üìä</span>
            <span>Statistika</span>
        </button>
    </div>
    <script>
        // ===========================================
        // DATA
        // ===========================================
        const DATES_DATA = {
  "dejtovi": [
    {"id": 1, "kategorija": "DNEVNI", "naziv": "GRABAR", "opis": "Pro≈°eƒáite do Grabara na sladoled/kolaƒç", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 2, "kategorija": "DNEVNI", "naziv": "POLUPANSION", "opis": "Napravite si doruƒçak u krevetu", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 3, "kategorija": "DNEVNI", "naziv": "KOLAƒåI", "opis": "Napravite svako svoju vrstu kolaƒça", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 4, "kategorija": "DNEVNI", "naziv": "QUIZ", "opis": "Odigrajte neki ljubavni kviz jedno o drugome", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 5, "kategorija": "DNEVNI", "naziv": "LOVE LETTER", "opis": "Napi≈°ite si ljubavno pismo", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 6, "kategorija": "DNEVNI", "naziv": "PIKNIK", "opis": "Uzmite Yodu, dekice i grickalice", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 7, "kategorija": "DNEVNI", "naziv": "DRU≈†TVENA IGRA", "opis": "Kupite novu dru≈°tvenu igru i igrajte barem sat vremena", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 8, "kategorija": "DNEVNI", "naziv": "VIDIKOVAC", "opis": "Odite do nekog vidikovca (Sljeme, Tepec, Glavica‚Ä¶)", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 9, "kategorija": "DNEVNI", "naziv": "TUƒêA KUHINJA", "opis": "Skuhajte tradicionalno jelo neke random dr≈æave", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 10, "kategorija": "DNEVNI", "naziv": "PUZZLE", "opis": "Kupite i slo≈æite puzzle", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 11, "kategorija": "DNEVNI", "naziv": "CRTIƒÜ", "opis": "Odgledajte neki sinkronizirani film", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 12, "kategorija": "DNEVNI", "naziv": "SPA", "opis": "Organizirajte SPA veƒçer u kupaoni sa svijeƒáama, maskama za lice itd.", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 13, "kategorija": "DNEVNI", "naziv": "HOT HOT", "opis": "Sredite se jedno za drugo", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 14, "kategorija": "DNEVNI", "naziv": "DVORAC", "opis": "Slo≈æite dvorac u dnevnom boravku s dekama i jastucima", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 15, "kategorija": "DNEVNI", "naziv": "CUBE", "opis": "Pro≈°eƒáite do Cubea na kavu, koktel ili sok", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 16, "kategorija": "DNEVNI", "naziv": "COCKTAIL", "opis": "Slo≈æite si svoj koktel doma, mo≈æe i bezalkoholni", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 17, "kategorija": "DNEVNI", "naziv": "ZALAZAK", "opis": "Pred zalazak pustite ≈°to radite i u≈æivajte u pogledu", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 18, "kategorija": "DNEVNI", "naziv": "EARLY BIRD GETS THE WORM", "opis": "Probudite se ranije i popijte kavu skupa", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 19, "kategorija": "DNEVNI", "naziv": "YOGA", "opis": "Odradite yogu skupa", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 20, "kategorija": "DNEVNI", "naziv": "SING", "opis": "Pjevajte karaoke ili neki kviz", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 21, "kategorija": "DNEVNI", "naziv": "COLORFULL", "opis": "Obojajte svako po pola crte≈æa i spojite u jedan", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 22, "kategorija": "DNEVNI", "naziv": "GAMING", "opis": "Odigrajte sat vremena neke igrice skupa", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 23, "kategorija": "DNEVNI", "naziv": "RASTA", "opis": "Kupite novu biljku i podijelite brigu o njoj", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 24, "kategorija": "DNEVNI", "naziv": "KLARA'S FAVOURITE", "opis": "Izmasirajte jedno drugo 15minuta", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 25, "kategorija": "DNEVNI", "naziv": "LATE NIGHT", "opis": "Sjednite u auto i provozajte se pola sata po noƒái", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 26, "kategorija": "DNEVNI", "naziv": "FANTASY", "opis": "Napravite svoje zmajeve i isprobajte", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 27, "kategorija": "DNEVNI", "naziv": "DANCE BABY", "opis": "Odradite plesni tutorial s youtubea", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 28, "kategorija": "DNEVNI", "naziv": "NOSTALGIJA", "opis": "Prisjetite se starih dogaƒëanja, slika i zahvalite se na tome gdje ste sada", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 29, "kategorija": "DNEVNI", "naziv": "ORIGAMI", "opis": "Napravite origami", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 30, "kategorija": "DNEVNI", "naziv": "FLY AWAY", "opis": "Napravite papirnate avione i natjecanje od 3 runde koji ƒáe dalje letjeti", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 31, "kategorija": "DNEVNI", "naziv": "PHOTO BOMB", "opis": "Napravite photo session jedno drugog, barem 5 slika", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 32, "kategorija": "VIKEND", "naziv": "IZLET", "opis": "Pro≈°eƒáite po obli≈ænjem gradu Sam/Zap/Vg‚Ä¶", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 33, "kategorija": "VIKEND", "naziv": "NEDJELJA", "opis": "Posjetite Klarine roditelje ko i svaku nedjelju kad nemate ≈°to jest", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 34, "kategorija": "VIKEND", "naziv": "TOO MUCH PEOPLE", "opis": "Posjetite Josipove roditelje", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 35, "kategorija": "VIKEND", "naziv": "FRENDAƒÜI", "opis": "Odite do Tine i Maria", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 36, "kategorija": "VIKEND", "naziv": "MOVIE NIGHT", "opis": "Napravite filmski maraton (Preporuka: Neil Breen)", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 37, "kategorija": "VIKEND", "naziv": "SERIES NIGHT", "opis": "Bingeajte limitiranu seriju u jednom danu", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 38, "kategorija": "VIKEND", "naziv": "NO STOPING", "opis": "Pro≈°eƒáite 10 000 koraka u danu", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 39, "kategorija": "VIKEND", "naziv": "SLA≈ΩEM EGO KAO LEGO", "opis": "Kupite i slo≈æite lego kocke", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 40, "kategorija": "VIKEND", "naziv": "RESTAƒå", "opis": "Odite u neki restoran na veƒçeru", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 41, "kategorija": "VIKEND", "naziv": "CAW", "opis": "Uplatite clay and wine", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 42, "kategorija": "VIKEND", "naziv": "LEVI", "opis": "Odgledajte neki kratki anime", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 43, "kategorija": "VIKEND", "naziv": "CINESTAR", "opis": "Odite u kino odgledat neki film", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 44, "kategorija": "VIKEND", "naziv": "BOWLING", "opis": "Odite na kuglanje", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 45, "kategorija": "VIKEND", "naziv": "BOORIIING", "opis": "Odite u muzej", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 46, "kategorija": "VIKEND", "naziv": "PAW", "opis": "Uplatite paint and wine", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 47, "kategorija": "MJESEƒåNI", "naziv": "EWW IT'S RAW", "opis": "Odite na sushi", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 48, "kategorija": "MJESEƒåNI", "naziv": "TOPLICE", "opis": "Odite u toplice na jedan dan", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 49, "kategorija": "MJESEƒåNI", "naziv": "VECNA'S MIND", "opis": "Odite u escape room", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 50, "kategorija": "MJESEƒåNI", "naziv": "NP", "opis": "Odite u neki nacionalni park", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 51, "kategorija": "MJESEƒåNI", "naziv": "PIZZA", "opis": "Uplatite si teƒçaj izrade pizze", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 52, "kategorija": "MJESEƒåNI", "naziv": "BAMBI", "opis": "Posjetite dolinu jelena", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 53, "kategorija": "MJESEƒåNI", "naziv": "HAWK TUAH", "opis": "Posjetite ranch alpaka", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 54, "kategorija": "MJESEƒåNI", "naziv": "STAND UP", "opis": "Uplatite si neki stand up nastup", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 55, "kategorija": "MJESEƒåNI", "naziv": "OBRAZOVANJE", "opis": "Odite u kazali≈°te", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 56, "kategorija": "MJESEƒåNI", "naziv": "ZASLU≈ΩILI SMO", "opis": "Odmorite se jedan vikend na nekom mjestu", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 57, "kategorija": "GODI≈†NJI", "naziv": "TRESU MI SE GAƒÜE", "opis": "Uplatite si let balonom na vruƒái zrak", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 58, "kategorija": "GODI≈†NJI", "naziv": "PASTA", "opis": "Odvezite se do Italije po pizzu i vratite natrag", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 59, "kategorija": "GODI≈†NJI", "naziv": "ONE STAR", "opis": "Odite u restoran s Michelin zvjezdicom", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null},
    {"id": 60, "kategorija": "GODI≈†NJI", "naziv": "SIƒêI DOLJE", "opis": "Uplatite si kuƒáicu na drvetu", "odradjen": false, "datumOdradjivanja": null, "slikaPath": null}
  ]
};

        const EASTER_EGG_HINTS = {
            1: {title: "Tajni Dejt #1: Opu≈°tanje", hint: "Svaki DAN udahni i izdahni 3 sekunde"},
            2: {title: "Tajni Dejt #2: Jutarnje Iznenaƒëenje", hint: "Brzo putuj kroz navigaciju"},
            3: {
                stage1: {title: "Tajni Dejt #3: Master Secret", hint: "Treba mi godi≈°nji"},
                stage2: {title: "Tajni Dejt #3: Master Secret", hint: "≈†to smo ja+ti"}
            },
            4: {title: "Tajni Dejt #4: Romantiƒçni Bonus", hint: "STAni, TI Si Tako lijepa I oƒçi su ti KAo ƒçokolada, pojeo bih te u 5 sekundi"}
        };

        // ===========================================
        // STATE MANAGEMENT - FIX #2: activeDejtovi spremanje
        // ===========================================
        let currentCategory = null;
        let currentDate = null;
        let currentScreen = 'home';
        let selectedImage = null;
        let secretDiscovered = false;
        let activeDejtovi = []; // FIX: Now persisted in IndexedDB
        
        let easterEggState = {1: false, 2: false, 3: false, 4: false, '3_modalOpened': false};
        let tapCount = 0, tapTimer = null, navTapSequence = [], navTapSequenceTimer = null;
        let loveAnimationInterval = null;
        const NAV_TAP_PATTERN = ['home', 'gallery', 'stats'], HOLD_DURATION_3S = 3000, HOLD_DURATION_5S = 5000;

        let db;
        const DB_NAME = 'OurDatesDB', DB_VERSION = 2;

        // ===========================================
        // INDEXEDDB
        // ===========================================
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('dates')) db.createObjectStore('dates', {keyPath: 'id'});
                    if (!db.objectStoreNames.contains('images')) db.createObjectStore('images', {keyPath: 'dateId'});
                    if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', {keyPath: 'key'});
                    if (!db.objectStoreNames.contains('easterEggs')) db.createObjectStore('easterEggs', {keyPath: 'id'});
                };
            });
        }

        async function loadState() {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['dates'], 'readonly');
                const request = transaction.objectStore('dates').getAll();
                request.onsuccess = () => {
                    request.result.forEach(savedDate => {
                        const date = DATES_DATA.dejtovi.find(d => d.id === savedDate.id);
                        if (date) { 
                            date.odradjen = savedDate.odradjen; 
                            date.datumOdradjivanja = savedDate.datumOdradjivanja; 
                            date.slikaPath = savedDate.slikaPath; 
                        }
                    });
                    resolve();
                };
                request.onerror = () => reject(request.error);
            });
        }

        // FIX #2: Load/Save activeDejtovi from IndexedDB
        async function loadActiveDejtovi() {
            const saved = await getSetting('activeDejtovi');
            if (saved && Array.isArray(saved)) {
                activeDejtovi = saved;
                updateHomeScreenState();
                
                // Ako ima aktivnih, prebaci na upload screen
                if (activeDejtovi.length > 0) {
                    showScreen('home'); // Uvijek prika≈æi home prvo
                    updateUploadScreenState();
                }
            }
        }

        async function saveActiveDejtovi() {
            await saveSetting('activeDejtovi', activeDejtovi);
        }

        async function loadEasterEggState() {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['easterEggs'], 'readonly');
                const request = transaction.objectStore('easterEggs').getAll();
                request.onsuccess = () => {
                    request.result.forEach(egg => { easterEggState[egg.id] = egg.completed; });
                    resolve();
                };
                request.onerror = () => reject(request.error);
            });
        }

        async function saveEasterEggProgress(id, completed) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const request = db.transaction(['easterEggs'], 'readwrite').objectStore('easterEggs').put({id: String(id), completed});
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function saveDate(date) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const request = db.transaction(['dates'], 'readwrite').objectStore('dates').put(date);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function saveImage(dateId, imageBlob) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const request = db.transaction(['images'], 'readwrite').objectStore('images').put({dateId, imageBlob});
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getImage(dateId) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const request = db.transaction(['images'], 'readonly').objectStore('images').get(dateId);
                request.onsuccess = () => resolve(request.result ? request.result.imageBlob : null);
                request.onerror = () => reject(request.error);
            });
        }

        async function saveSetting(key, value) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const request = db.transaction(['settings'], 'readwrite').objectStore('settings').put({key, value});
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getSetting(key) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const request = db.transaction(['settings'], 'readonly').objectStore('settings').get(key);
                request.onsuccess = () => resolve(request.result ? request.result.value : null);
                request.onerror = () => reject(request.error);
            });
        }

        async function saveLastActiveDate() { await saveSetting('lastActiveDate', new Date().toISOString()); }

        async function checkInactivity() {
            const completedDates = DATES_DATA.dejtovi.filter(d => d.odradjen);
            if (completedDates.length === 0) return;
            const lastDate = new Date(completedDates.sort((a,b) => new Date(b.datumOdradjivanja) - new Date(a.datumOdradjivanja))[0].datumOdradjivanja);
            const daysDiff = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));
            if (daysDiff >= 7) document.getElementById('warningModal').classList.add('active');
        }

        function closeWarning() { document.getElementById('warningModal').classList.remove('active'); }

        async function checkSecretStatus() {
            secretDiscovered = await getSetting('secretDiscovered') === true;
            const logoEmoji = document.getElementById('logoEmoji');
            logoEmoji.classList[secretDiscovered ? 'remove' : 'add']('locked');
        }

        async function unlockSecret() {
            if (!secretDiscovered) {
                secretDiscovered = true;
                await saveSetting('secretDiscovered', true);
                const logoEmoji = document.getElementById('logoEmoji');
                logoEmoji.classList.remove('locked');
                logoEmoji.classList.add('unlocking');
                setTimeout(() => logoEmoji.classList.remove('unlocking'), 800);
            }
        }

        // ===========================================
        // FIX #4: HOME SCREEN LOGIC - Godi≈°nji uvijek otvoren
        // ===========================================
        function updateHomeScreenState() {
            const dnevniBtn = document.getElementById('dnevniBtn');
            const vikendBtn = document.getElementById('vikendBtn');
            const mjesecniBtn = document.getElementById('mjesecniBtn');
            const godisnjiBtn = document.getElementById('godisnjiBtn');
            
            // Provjeri ima li aktivnih dejtova
            const hasActive = activeDejtovi.length > 0;
            const hasGodisnji = activeDejtovi.some(item => item.category === 'GODI≈†NJI');
            const hasNonGodisnji = activeDejtovi.some(item => item.category !== 'GODI≈†NJI');
            
            // PRAVILO: Godi≈°nji je uvijek otvoren dok nije odabran
            godisnjiBtn.disabled = hasGodisnji;
            
            if (!hasActive) {
                // Nema aktivnih - sve otkljuƒçano
                dnevniBtn.disabled = false;
                vikendBtn.disabled = false;
                mjesecniBtn.disabled = false;
            } else if (hasGodisnji && !hasNonGodisnji) {
                // Samo godi≈°nji aktivan - mo≈æe≈° birati DNEVNI/VIKEND/MJESEƒåNI
                dnevniBtn.disabled = false;
                vikendBtn.disabled = false;
                mjesecniBtn.disabled = false;
            } else if (hasNonGodisnji) {
                // Ima≈° DNEVNI/VIKEND/MJESEƒåNI - sve zakljuƒçano osim godi≈°njeg ako nije odabran
                dnevniBtn.disabled = true;
                vikendBtn.disabled = true;
                mjesecniBtn.disabled = true;
            } else if (activeDejtovi.length >= 2) {
                // Veƒá ima≈° 2 - sve zakljuƒçano
                dnevniBtn.disabled = true;
                vikendBtn.disabled = true;
                mjesecniBtn.disabled = true;
            }
        }
        
        function updateUploadScreenState() {
            const dateSelector = document.getElementById('dateSelector');
            const dateSelectorDropdown = document.getElementById('dateSelectorDropdown');
            const cancelBtn = document.getElementById('cancelUploadBtn');
            
            if (activeDejtovi.length === 2) {
                // Prika≈æi dropdown
                dateSelector.style.display = 'block';
                dateSelectorDropdown.innerHTML = '';
                
                activeDejtovi.forEach((item, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${item.category} - ${item.date.naziv}`;
                    dateSelectorDropdown.appendChild(option);
                });
                
                cancelBtn.style.display = 'none';
            } else if (activeDejtovi.length === 1) {
                dateSelector.style.display = 'none';
                
                const category = activeDejtovi[0].category;
                
                if (category === 'GODI≈†NJI') {
                    cancelBtn.style.display = 'block';
                } else {
                    cancelBtn.style.display = 'none';
                }
            } else {
                dateSelector.style.display = 'none';
                cancelBtn.style.display = 'none';
            }
        }

        // ===========================================
        // CATEGORY SELECTION - FIX #1: Dodani event listeneri za VIKEND i MJESEƒåNI
        // ===========================================
        function selectCategory(category) {
            currentCategory = category;
            
            const alreadyActive = activeDejtovi.some(item => item.category === category);
            if (alreadyActive) {
                alert('Veƒá ima≈° aktiviran dejt iz te kategorije!');
                return;
            }
            
            const availableDates = DATES_DATA.dejtovi.filter(d => 
                d.kategorija === category && !d.odradjen
            );
            
            if (availableDates.length === 0) {
                alert('Svi dejtovi iz ove kategorije su veƒá odraƒëeni! üéâ');
                return;
            }
            
            currentDate = availableDates[Math.floor(Math.random() * availableDates.length)];
            
            document.getElementById('dateTitle').textContent = currentDate.naziv;
            document.getElementById('dateDescription').textContent = currentDate.opis;
            document.getElementById('flipCard').classList.remove('flipped');
            document.getElementById('dateScreen').classList.add('active');
            document.getElementById('homeScreen').classList.remove('active');
        }
        
        function toggleFlip() {
            document.getElementById('flipCard').classList.toggle('flipped');
        }
        
        async function acceptDate() {
            if (!currentDate || !currentCategory) return;
            
            activeDejtovi.push({
                date: currentDate,
                category: currentCategory
            });
            
            await saveActiveDejtovi();
            updateHomeScreenState();
            
            document.getElementById('dateScreen').classList.remove('active');
            document.getElementById('uploadScreen').classList.add('active');
            updateUploadScreenState();
            
            currentDate = null;
            currentCategory = null;
        }
        
        function replaceDate() {
            selectCategory(currentCategory);
        }
        
        // FIX #5: Navigacija natrag s date screena
        function goBackFromDate() {
            currentDate = null;
            currentCategory = null;
            document.getElementById('dateScreen').classList.remove('active');
            
            if (activeDejtovi.length > 0) {
                // Ako veƒá ima≈° aktivne dejtove, vrati se na upload
                document.getElementById('uploadScreen').classList.add('active');
            } else {
                // Inaƒçe na home
                document.getElementById('homeScreen').classList.add('active');
            }
        }

        // ===========================================
        // IMAGE UPLOAD
        // ===========================================
        function openCamera() {
            document.getElementById('cameraInput').click();
        }

        function openGallery() {
            document.getElementById('galleryInput').click();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            selectedImage = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewContainer').innerHTML = `
                    <img src="${e.target.result}" class="preview-image">
                    <button class="btn btn-accept" style="width: 100%; margin-top: 20px;" onclick="confirmUpload()">
                        Potvrdi i Spremi
                    </button>
                `;
            };
            reader.readAsDataURL(file);
        }

        async function confirmUpload() {
            if (!selectedImage) {
                alert('Prvo odaberi sliku!');
                return;
            }
            
            let dateToUpload = null;
            let indexToRemove = -1;
            
            if (activeDejtovi.length === 2) {
                const selectedIndex = parseInt(document.getElementById('dateSelectorDropdown').value);
                dateToUpload = activeDejtovi[selectedIndex].date;
                indexToRemove = selectedIndex;
            } else if (activeDejtovi.length === 1) {
                dateToUpload = activeDejtovi[0].date;
                indexToRemove = 0;
            } else {
                alert('Gre≈°ka: Nema aktivnih dejtova!');
                return;
            }
            
            dateToUpload.odradjen = true;
            dateToUpload.datumOdradjivanja = new Date().toISOString();
            dateToUpload.slikaPath = `date_${dateToUpload.id}`;
            
            await saveDate(dateToUpload);
            await saveImage(dateToUpload.id, selectedImage);
            await saveLastActiveDate();
            
            activeDejtovi.splice(indexToRemove, 1);
            await saveActiveDejtovi();
            
            selectedImage = null;
            document.getElementById('previewContainer').innerHTML = '';
            document.getElementById('cameraInput').value = '';
            document.getElementById('galleryInput').value = '';
            
            updateHomeScreenState();
            
            if (activeDejtovi.length === 0) {
                alert('Dejt uspje≈°no odraƒëen! üéâ');
                showScreen('home');
            } else {
                alert('Super! Sad uploadaj sliku za preostali dejt!');
                updateUploadScreenState();
            }
        }

        async function cancelUpload() {
            if (activeDejtovi.length === 1 && activeDejtovi[0].category === 'GODI≈†NJI') {
                activeDejtovi = [];
                await saveActiveDejtovi();
                
                selectedImage = null;
                document.getElementById('previewContainer').innerHTML = '';
                document.getElementById('cameraInput').value = '';
                document.getElementById('galleryInput').value = '';
                
                updateHomeScreenState();
                
                document.getElementById('uploadScreen').classList.remove('active');
                showScreen('home');
            } else {
                alert('Ne mo≈æe≈° odustati - mora≈° uploadati sliku!');
            }
        }

        // ===========================================
        // TRACKER + EASTER EGGS
        // ===========================================
        async function showTracker() {
            const completedCount = Object.keys(easterEggState).filter(key => !key.includes('_') && easterEggState[key] === true).length;
            document.getElementById('trackerProgress').textContent = `${completedCount}/4`;
            const hint = getRandomHint();
            if (hint) {
                document.getElementById('trackerHintTitle').textContent = hint.title;
                document.getElementById('trackerHintText').textContent = hint.hint;
                document.getElementById('trackerHintSection').style.display = 'block';
            } else {
                document.getElementById('trackerHintSection').style.display = 'none';
            }
            document.getElementById('trackerModal').classList.add('active');
        }

        function getRandomHint() {
            const undiscovered = [];
            if (!easterEggState[1]) undiscovered.push(EASTER_EGG_HINTS[1]);
            if (!easterEggState[2]) undiscovered.push(EASTER_EGG_HINTS[2]);
            if (!easterEggState[3]) undiscovered.push(!easterEggState['3_modalOpened'] ? EASTER_EGG_HINTS[3].stage1 : EASTER_EGG_HINTS[3].stage2);
            if (!easterEggState[4]) undiscovered.push(EASTER_EGG_HINTS[4]);
            return undiscovered.length === 0 ? null : undiscovered[Math.floor(Math.random() * undiscovered.length)];
        }

        function closeTracker() { document.getElementById('trackerModal').classList.remove('active'); }

        async function completeEasterEgg(id) {
            easterEggState[id] = true;
            await saveEasterEggProgress(id, true);
            closeEasterModal('easterModal' + id);
            if (id === 3) closeEasterModal('easterModal3Success');
            if (id === 4) closeEasterModal('easterModal4Success');
        }

        // ===========================================
        // FIX: BUTTON EVENT HANDLERS - iOS Safari compatible
        // ===========================================
        
        // Globalne varijable za hold tracking
        let holdTimer = null;
        let holdTarget = null;
        let isHolding = false;
        
        function setupEasterEgg1() {
            const dnevniBtn = document.getElementById('dnevniBtn');
            
            // Touch events za hold (3 sekunde)
            dnevniBtn.addEventListener('touchstart', (e) => {
                if (easterEggState[1]) return;
                
                isHolding = true;
                holdTarget = 'dnevni';
                dnevniBtn.classList.add('holding');
                
                holdTimer = setTimeout(() => {
                    dnevniBtn.classList.remove('holding');
                    document.getElementById('easterModal1').classList.add('active');
                    isHolding = false;
                    holdTarget = null;
                }, HOLD_DURATION_3S);
            }, {passive: true});
            
            dnevniBtn.addEventListener('touchend', (e) => {
                if (holdTarget === 'dnevni') {
                    clearTimeout(holdTimer);
                    dnevniBtn.classList.remove('holding');
                    
                    const wasHolding = isHolding;
                    isHolding = false;
                    holdTarget = null;
                    
                    // Ako nije bio hold, trigeruj normalan click
                    if (wasHolding && !dnevniBtn.disabled) {
                        setTimeout(() => selectCategory('DNEVNI'), 100);
                    }
                }
            }, {passive: true});
            
            // Fallback za desktop (mouse click)
            dnevniBtn.addEventListener('click', (e) => {
                if (!isHolding && !dnevniBtn.disabled) {
                    selectCategory('DNEVNI');
                }
            });
        }
        
        // FIX #1: VIKEND button - jednostavan click
        function setupVikendButton() {
            const vikendBtn = document.getElementById('vikendBtn');
            
            // Touch za mobile
            vikendBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (!vikendBtn.disabled) {
                    selectCategory('VIKEND');
                }
            });
            
            // Click za desktop
            vikendBtn.addEventListener('click', (e) => {
                if (!vikendBtn.disabled) {
                    selectCategory('VIKEND');
                }
            });
        }
        
        // FIX #1: MJESEƒåNI button - jednostavan click
        function setupMjesecniButton() {
            const mjesecniBtn = document.getElementById('mjesecniBtn');
            
            // Touch za mobile
            mjesecniBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (!mjesecniBtn.disabled) {
                    selectCategory('MJESEƒåNI');
                }
            });
            
            // Click za desktop
            mjesecniBtn.addEventListener('click', (e) => {
                if (!mjesecniBtn.disabled) {
                    selectCategory('MJESEƒåNI');
                }
            });
        }
        
        function setupEasterEgg3() {
            const godisnjiBtn = document.getElementById('godisnjiBtn');
            
            // Touch events za hold (3 sekunde)
            godisnjiBtn.addEventListener('touchstart', (e) => {
                if (easterEggState[3]) return;
                
                isHolding = true;
                holdTarget = 'godisnji';
                godisnjiBtn.classList.add('holding');
                
                holdTimer = setTimeout(async () => {
                    godisnjiBtn.classList.remove('holding');
                    document.getElementById('easterModal3').classList.add('active');
                    document.getElementById('secretCodeInput').value = '';
                    easterEggState['3_modalOpened'] = true;
                    await saveEasterEggProgress('3_modalOpened', true);
                    isHolding = false;
                    holdTarget = null;
                }, HOLD_DURATION_3S);
            }, {passive: true});
            
            godisnjiBtn.addEventListener('touchend', (e) => {
                if (holdTarget === 'godisnji') {
                    e.preventDefault(); // üëà DODAJ!
                    clearTimeout(holdTimer);
                    godisnjiBtn.classList.remove('holding');
                    
                    const wasHolding = isHolding;
                    isHolding = false;
                    holdTarget = null;
                    
                    if (wasHolding && !godisnjiBtn.disabled) {
                        setTimeout(() => selectCategory('GODI≈†NJI'), 100);
                    }
                }
            });
            
            // Fallback za desktop (mouse click)
            godisnjiBtn.addEventListener('click', (e) => {
                if (!isHolding && !godisnjiBtn.disabled) {
                    selectCategory('GODI≈†NJI');
                }
            });
        }
        
        function setupEasterEgg4() {
            const statsNavBtn = document.getElementById('statsNavBtn');
            let statsHolding = false;
            
            statsNavBtn.addEventListener('touchstart', (e) => {
                if (easterEggState[4]) return;
                
                statsHolding = true;
                holdTarget = 'stats';
                statsNavBtn.classList.add('holding');
                
                holdTimer = setTimeout(() => {
                    statsNavBtn.classList.remove('holding');
                    document.getElementById('easterModal4').classList.add('active');
                    document.getElementById('mathAnswerInput').value = '';
                    statsHolding = false;
                    holdTarget = null;
                }, HOLD_DURATION_5S);
            }, {passive: true});
            
            statsNavBtn.addEventListener('touchend', (e) => {
                if (holdTarget === 'stats') {
                    clearTimeout(holdTimer);
                    statsNavBtn.classList.remove('holding');
                    
                    const wasHolding = statsHolding;
                    statsHolding = false;
                    holdTarget = null;
                    
                    // Ako nije bio hold, trigeruj normalan navigation
                    if (wasHolding) {
                        setTimeout(() => showScreen('stats'), 100);
                    }
                }
            }, {passive: true});
            
            // Fallback za desktop (mouse click) - veƒá ima u navClick
        }


        function setupEasterEgg2() {
            function addToNavSequence(element) {
                if (easterEggState[2]) return;
                navTapSequence.push(element);
                if (navTapSequenceTimer) clearTimeout(navTapSequenceTimer);
                navTapSequenceTimer = setTimeout(() => { navTapSequence = []; }, 2000);
                if (navTapSequence.length === NAV_TAP_PATTERN.length) {
                    let match = true;
                    for (let i = 0; i < NAV_TAP_PATTERN.length; i++) {
                        if (navTapSequence[i] !== NAV_TAP_PATTERN[i]) { match = false; break; }
                    }
                    if (match) { navTapSequence = []; document.getElementById('easterModal2').classList.add('active'); }
                }
            }
            window.navClick = function(destination) { 
                addToNavSequence(destination); 
                
                // FIX: Ako ima≈° aktivne dejtove, home = upload
                if (destination === 'home' && activeDejtovi.length > 0) {
                    showScreen('upload');
                } else {
                    showScreen(destination);
                }
            };

        }

        function setupEasterEgg3() {
            const godisnjiBtn = document.getElementById('godisnjiBtn');
            godisnjiBtn.addEventListener('touchstart', (e) => {
                if (easterEggState[3]) return;
                holdTarget = 'godisnji';
                godisnjiBtn.classList.add('holding');
                holdTimer = setTimeout(async () => {
                    godisnjiBtn.classList.remove('holding');
                    document.getElementById('easterModal3').classList.add('active');
                    document.getElementById('secretCodeInput').value = '';
                    easterEggState['3_modalOpened'] = true;
                    await saveEasterEggProgress('3_modalOpened', true);
                    holdTarget = null;
                }, HOLD_DURATION_3S);
            });
            godisnjiBtn.addEventListener('touchend', (e) => {
                if (holdTarget === 'godisnji') {
                    clearTimeout(holdTimer);
                    godisnjiBtn.classList.remove('holding');
                    setTimeout(() => { 
                        if (holdTarget === null && !godisnjiBtn.disabled) selectCategory('GODI≈†NJI'); 
                        holdTarget = null; 
                    }, 50);
                }
            });
            godisnjiBtn.addEventListener('click', (e) => { 
                if (!holdTarget && !godisnjiBtn.disabled) selectCategory('GODI≈†NJI'); 
            });
        }

        function checkSecretCode() {
            const input = document.getElementById('secretCodeInput').value;
            if (input === '3421') {
                document.getElementById('easterModal3').classList.remove('active');
                document.getElementById('easterModal3Success').classList.add('active');
            } else {
                alert('‚ùå Netoƒçna ≈°ifra! Poku≈°aj ponovno.\n\nHint: Datum kada je na≈°a priƒça poƒçela (DDMM)');
                document.getElementById('secretCodeInput').value = '';
            }
        }

        function setupEasterEgg4() {
            const statsNavBtn = document.getElementById('statsNavBtn');
            statsNavBtn.addEventListener('touchstart', (e) => {
                if (easterEggState[4]) return;
                holdTarget = 'stats';
                statsNavBtn.classList.add('holding');
                holdTimer = setTimeout(() => {
                    statsNavBtn.classList.remove('holding');
                    document.getElementById('easterModal4').classList.add('active');
                    document.getElementById('mathAnswerInput').value = '';
                    holdTarget = null;
                }, HOLD_DURATION_5S);
            });
            statsNavBtn.addEventListener('touchend', (e) => {
                if (holdTarget === 'stats') {
                    clearTimeout(holdTimer);
                    statsNavBtn.classList.remove('holding');
                    setTimeout(() => { 
                        if (holdTarget === null) showScreen('stats'); 
                        holdTarget = null; 
                    }, 50);
                }
            });
            statsNavBtn.addEventListener('click', (e) => { 
                if (!holdTarget) showScreen('stats'); 
            });
        }

        function checkMathAnswer() {
            const input = parseInt(document.getElementById('mathAnswerInput').value);
            if (input === 4) {
                document.getElementById('easterModal4').classList.remove('active');
                document.getElementById('easterModal4Success').classList.add('active');
            } else {
                alert('‚ùå Netoƒçno! Poku≈°aj ponovno.\n\nHint: Rije≈°i sustav jednad≈æbi!');
                document.getElementById('mathAnswerInput').value = '';
            }
        }

        function closeEasterModal(modalId) { 
            document.getElementById(modalId).classList.remove('active'); 
        }

        // ===========================================
        // LOVE ANIMATION
        // ===========================================
        document.getElementById('logoEmoji').addEventListener('click', function() {
            tapCount++;
            if (tapTimer) clearTimeout(tapTimer);
            tapTimer = setTimeout(() => {
                if (tapCount === 2) triggerLoveAnimation();
                else if (tapCount === 3) triggerReset();
                tapCount = 0;
            }, 500);
        });

        async function triggerLoveAnimation() {
            document.getElementById('loveOverlay').classList.add('active');
            await unlockSecret();
            loveAnimationInterval = setInterval(() => createFloatingHeart(), 300);
            for (let i = 0; i < 10; i++) setTimeout(() => createFloatingHeart(), i * 100);
        }

        function createFloatingHeart() {
            const heart = document.createElement('div');
            heart.className = 'floating-heart';
            const hearts = ['üíï', 'üíñ', 'üíó', 'üíì', 'üíû', 'üíù', '‚ù§Ô∏è', 'ü©∑'];
            heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
            const startX = Math.random() * window.innerWidth, startY = window.innerHeight + 50;
            heart.style.left = startX + 'px';
            heart.style.top = startY + 'px';
            const randomX = (Math.random() - 0.5) * 400, randomRotate = (Math.random() - 0.5) * 720, duration = 6 + Math.random() * 4;
            heart.style.setProperty('--random-x', randomX + 'px');
            heart.style.setProperty('--random-rotate', randomRotate + 'deg');
            heart.style.animationDuration = duration + 's';
            document.getElementById('loveOverlay').appendChild(heart);
            setTimeout(() => { if (heart.parentNode) heart.remove(); }, duration * 1000);
        }

        function closeLoveAnimation() {
            document.getElementById('loveOverlay').classList.remove('active');
            if (loveAnimationInterval) { clearInterval(loveAnimationInterval); loveAnimationInterval = null; }
            document.querySelectorAll('.floating-heart').forEach(heart => heart.remove());
        }

        function triggerReset() {
            if (confirm('üîÑ SECRET RESET\n\nOvo ƒáe obrisati sve podatke i slike!\n\nSigurno?')) {
                if (confirm('Stvarno sigurno?')) resetAllData();
            }
        }

        async function resetAllData() {
            if (!db) await initDB();
            const transaction = db.transaction(['dates', 'images', 'settings', 'easterEggs'], 'readwrite');
            transaction.objectStore('dates').clear();
            transaction.objectStore('images').clear();
            transaction.objectStore('settings').clear();
            transaction.objectStore('easterEggs').clear();
            DATES_DATA.dejtovi.forEach(date => { 
                date.odradjen = false; 
                date.datumOdradjivanja = null; 
                date.slikaPath = null; 
            });
            activeDejtovi = [];
            transaction.oncomplete = () => { 
                alert('‚úÖ Reset uspje≈°an!'); 
                location.reload(); 
            };
        }

        // ===========================================
        // NAVIGATION
        // ===========================================
        function showScreen(screen) {
            currentScreen = screen;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            if (screen === 'home') {
                document.getElementById('homeScreen').classList.add('active');
                document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
            } else if (screen === 'upload') {
                document.getElementById('uploadScreen').classList.add('active');
                document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
                updateUploadScreenState();
            } else if (screen === 'gallery') {
                document.getElementById('galleryScreen').classList.add('active');
                document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
                loadGallery();
            } else if (screen === 'stats') {
                document.getElementById('statsScreen').classList.add('active');
                document.querySelector('.nav-btn:nth-child(3)').classList.add('active');
                loadStats();
            }
        }

        // ===========================================
        // GALLERY
        // ===========================================
        async function loadGallery() {
            const completedDates = DATES_DATA.dejtovi.filter(d => d.odradjen).sort((a,b) => new Date(b.datumOdradjivanja) - new Date(a.datumOdradjivanja));
            const galleryGrid = document.getElementById('galleryGrid'), emptyState = document.getElementById('emptyGallery');
            if (completedDates.length === 0) { 
                galleryGrid.innerHTML = ''; 
                emptyState.style.display = 'block'; 
                return; 
            }
            emptyState.style.display = 'none';
            galleryGrid.innerHTML = '';
            for (const date of completedDates) {
                const imageBlob = await getImage(date.id);
                if (imageBlob) {
                    const imageUrl = URL.createObjectURL(imageBlob), formattedDate = new Date(date.datumOdradjivanja).toLocaleDateString('hr-HR');
                    const item = document.createElement('div');
                    item.className = 'gallery-item';
                    item.innerHTML = `<img src="${imageUrl}" alt="${date.naziv}"><div class="gallery-item-info">${date.naziv}<br>${formattedDate}</div>`;
                    item.onclick = () => showFullscreen(imageUrl);
                    galleryGrid.appendChild(item);
                }
            }
        }

        function showFullscreen(imageUrl) { 
            document.getElementById('fullscreenImage').src = imageUrl; 
            document.getElementById('fullscreenOverlay').classList.add('active'); 
        }
        
        function closeFullscreen() { 
            document.getElementById('fullscreenOverlay').classList.remove('active'); 
        }

        // ===========================================
        // STATS
        // ===========================================
        function loadStats() {
            const completed = DATES_DATA.dejtovi.filter(d => d.odradjen);
            document.getElementById('totalCompleted').textContent = completed.length;
            document.getElementById('dnevniCompleted').textContent = completed.filter(d => d.kategorija === 'DNEVNI').length;
            document.getElementById('vikendCompleted').textContent = completed.filter(d => d.kategorija === 'VIKEND').length;
            document.getElementById('mjesecniCompleted').textContent = completed.filter(d => d.kategorija === 'MJESEƒåNI').length;
            document.getElementById('godisnjiCompleted').textContent = completed.filter(d => d.kategorija === 'GODI≈†NJI').length;
        }

        // ===========================================
        // EXPORT
        // ===========================================
        function exportJSON() {
            const exportData = {exportDate: new Date().toISOString(), dejtovi: DATES_DATA.dejtovi.map(d => ({id: d.id, kategorija: d.kategorija, naziv: d.naziv, opis: d.opis, odradjen: d.odradjen, datumOdradjivanja: d.datumOdradjivanja}))};
            const dataStr = JSON.stringify(exportData, null, 2), dataBlob = new Blob([dataStr], {type: 'application/json'}), url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `our-dates-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function exportZIP() {
            const completedDates = DATES_DATA.dejtovi.filter(d => d.odradjen);
            if (completedDates.length === 0) { alert('Nema slika za export!'); return; }
            const zip = new JSZip();
            for (const date of completedDates) {
                const imageBlob = await getImage(date.id);
                if (imageBlob) {
                    const dateStr = new Date(date.datumOdradjivanja).toISOString().split('T')[0];
                    const filename = `${dateStr}_${date.kategorija}_${date.naziv}.jpg`;
                    zip.file(filename, imageBlob);
                }
            }
            const zipBlob = await zip.generateAsync({type: 'blob'}), url = URL.createObjectURL(zipBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `our-dates-images-${new Date().toISOString().split('T')[0]}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ===========================================
        // INIT
        // ===========================================
        window.addEventListener('load', async () => {
            await initDB();
            await loadState();
            await loadEasterEggState();
            await loadActiveDejtovi(); // FIX #2: Load saved activeDejtovi
            await checkSecretStatus();
            await checkInactivity();
            await saveLastActiveDate();
            setupEasterEgg1();
            setupVikendButton(); // FIX #1
            setupMjesecniButton(); // FIX #1
            setupEasterEgg2();
            setupEasterEgg3();
            setupEasterEgg4();
            updateHomeScreenState();
            await showTracker();
            console.log('üéâ App loaded with ALL FIXES!');
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').then(reg => console.log('SW registered')).catch(err => console.log('SW failed', err));
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html>
